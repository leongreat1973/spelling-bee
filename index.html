<html lang="zh-TW"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜ä¸­è‹±æ–‡æ‹¼å­—å­¸ç¿’æ©Ÿ (Spelling Bee)</title>
    <style>
        :root{--primary-color:#0ea5e9;--primary-dark:#0284c7;--accent-color:#f59e0b;--bg-color:#f0f9ff;--card-bg:#ffffff;--text-main:#334155;--text-light:#64748b;--vowel-color:#ef4444;--consonant-color:#2563eb;--success:#22c55e;--error:#ef4444}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background-color:var(--bg-color);color:var(--text-main);margin:0;padding:0;min-height:100vh;display:flex;flex-direction:column}header{background-color:var(--primary-color);color:white;padding:10px 15px;box-shadow:0 2px 4px rgba(0,0,0,.1)}.header-content{max-width:800px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}h1{margin:0;font-size:1.1rem;letter-spacing:1px;white-space:nowrap}.header-controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}.set-select{padding:6px 10px;border-radius:20px;border:none;background:rgba(255,255,255,.9);color:var(--primary-dark);font-weight:700;font-size:.9rem;max-width:150px}.icon-btn{background:rgba(255,255,255,.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:.2s}.icon-btn:hover{background:rgba(255,255,255,.3)}.icon-btn.danger:hover{background:#ef4444}.add-btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:white;padding:6px 12px;border-radius:20px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;gap:5px;transition:.2s}.add-btn:hover{background:rgba(255,255,255,.3)}.tabs{display:flex;max-width:800px;margin:20px auto 0;padding:0 15px;width:100%;gap:5px;overflow-x:auto}.tab-btn{flex:1;padding:12px;background:#e0f2fe;border:none;border-radius:10px 10px 0 0;cursor:pointer;font-weight:700;color:var(--text-light);transition:.2s;font-size:.95rem;white-space:nowrap}.tab-btn.active{background:var(--card-bg);color:var(--primary-dark);box-shadow:0 -2px 5px rgba(0,0,0,.05)}main{flex:1;width:100%;max-width:800px;margin:0 auto;background:var(--card-bg);padding:10px;border-radius:0 0 15px 15px;box-shadow:0 4px 6px rgba(0,0,0,.05);display:flex;flex-direction:row;align-items:center;justify-content:space-between;position:relative;overflow:hidden}.content-container{flex:1;display:flex;flex-direction:column;align-items:center;width:100%;max-width:100%;padding:0 10px}.progress-indicator{font-size:.9rem;color:var(--text-light);background:#f1f5f9;padding:4px 12px;border-radius:20px;margin-bottom:10px;align-self:center}.nav-arrow{background:0 0;border:none;font-size:2.5rem;color:#cbd5e1;cursor:pointer;padding:10px;transition:.2s;user-select:none;display:flex;align-items:center;justify-content:center;height:100%;border-radius:10px}.nav-arrow:hover{color:var(--primary-color);background-color:#f0f9ff}.nav-arrow:active{transform:scale(.9)}.nav-arrow:disabled{color:#f1f5f9;cursor:not-allowed}.card-display{width:100%;text-align:center;margin-bottom:20px}.word-display{font-size:3.5rem;font-weight:700;margin:10px 0;line-height:1.2;min-height:80px;word-break:break-word;display:flex;justify-content:center;align-items:center;gap:15px;flex-wrap:wrap}.syllable-display{font-size:1.5rem;color:var(--text-light);margin-bottom:10px;font-family:'Courier New',monospace}.meaning-display{font-size:1.5rem;color:var(--primary-dark);margin-bottom:15px;font-weight:700;display:flex;justify-content:center;align-items:center;gap:10px}.sentence-display{background:#f8fafc;padding:15px;border-radius:10px;border-left:5px solid var(--accent-color);text-align:left;margin:10px 0;font-size:1.1rem;line-height:1.5;width:100%}.sentence-en{display:block;margin-bottom:8px;color:var(--text-main);font-weight:500}.sentence-cn{display:block;font-size:1rem;color:#475569;border-top:1px dashed #cbd5e1;padding-top:5px}.cloze-word{font-weight:700;color:var(--primary-color);margin:0 4px;white-space:nowrap}.cloze-line{display:inline-block;width:40px;border-bottom:2px solid var(--primary-color);margin:0 2px;vertical-align:middle;height:10px}.vowel{color:var(--vowel-color)}.consonant{color:var(--consonant-color)}.btn{background-color:var(--primary-color);color:white;border:none;padding:10px 20px;border-radius:50px;font-size:1rem;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:transform .1s,background .2s;box-shadow:0 2px 4px rgba(0,0,0,.2);margin:5px}.btn:active{transform:scale(.95)}.btn-outline{background:white;color:var(--primary-color);border:2px solid var(--primary-color)}.btn-lg{padding:15px 30px;font-size:1.2rem}.btn-icon{border-radius:50%;width:50px;height:50px;padding:0;justify-content:center}.btn-speaker{background-color:var(--accent-color);width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;border:none;cursor:pointer;color:white;box-shadow:0 2px 4px rgba(0,0,0,.2);transition:transform .1s}.btn-peek{background-color:#8b5cf6;color:white;padding:8px 16px;border-radius:20px;font-size:.9rem;border:none;cursor:pointer;margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,.2)}.btn-peek:disabled{background-color:#cbd5e1;cursor:default}.letter-pool,.answer-slot{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;min-height:60px;margin:10px 0}.letter-btn{width:45px;height:45px;background:white;border:2px solid var(--text-light);border-radius:8px;font-size:1.2rem;font-weight:700;color:var(--text-main);cursor:pointer;display:flex;justify-content:center;align-items:center;user-select:none;box-shadow:0 2px 0 rgba(0,0,0,.1);transition:.2s}.letter-btn.used{opacity:0;pointer-events:none}.answer-slot{background:#f1f5f9;border-radius:10px;padding:10px;border:2px dashed #cbd5e1}.answer-slot .letter-btn{border-color:var(--primary-color);color:var(--primary-color);background:white}@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-5px)}100%{transform:translateX(0)}}.shake{animation:shake .4s;border-color:var(--error)!important;color:var(--error)!important;background-color:#fef2f2!important}.input-group{margin:20px 0;width:100%;max-width:400px}input[type=text]{width:100%;padding:15px;font-size:1.5rem;text-align:center;border:2px solid #cbd5e1;border-radius:10px;outline:none}input[type=text]:focus{border-color:var(--primary-color)}.hint-text{font-family:'Courier New',monospace;font-size:2.5rem;letter-spacing:5px;color:var(--primary-color);margin:10px 0;font-weight:700}footer{padding:15px;background:white;border-top:1px solid #e2e8f0;display:flex;flex-direction:column;justify-content:center;align-items:center;position:sticky;bottom:0;gap:10px}.footer-btn-group{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}.footer-btn{background-color:#64748b;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;gap:5px}.footer-btn:hover{background-color:#475569}.footer-btn.primary{background-color:var(--primary-color)}.footer-btn.primary:hover{background-color:var(--primary-dark)}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:100;justify-content:center;align-items:center;padding:20px}.modal{background:white;padding:0;border-radius:15px;width:100%;max-width:500px;box-shadow:0 10px 25px rgba(0,0,0,.2);overflow:hidden;display:flex;flex-direction:column;max-height:90vh}.modal-header{padding:20px;background:var(--bg-color);border-bottom:1px solid #e2e8f0}.modal h2{margin:0;color:var(--text-main);text-align:center;font-size:1.4rem}.modal-tabs{display:flex;background:#e2e8f0}.modal-tab-btn{flex:1;padding:10px;border:none;background:0 0;cursor:pointer;font-weight:700;color:var(--text-light)}.modal-tab-btn.active{background:white;color:var(--primary-color)}.modal-body{padding:20px;overflow-y:auto;text-align:center}.form-group{margin-bottom:15px;text-align:left}.form-group label{display:block;margin-bottom:5px;font-weight:700;color:var(--text-light)}.form-group input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px;font-size:1rem}textarea.bulk-input{width:100%;height:200px;padding:10px;border:1px solid #cbd5e1;border-radius:8px;font-family:monospace;font-size:.9rem;resize:vertical}.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}.feedback-msg{font-size:1.2rem;font-weight:700;height:30px;margin-top:10px;opacity:0;transition:opacity .3s}.feedback-msg.show{opacity:1}.feedback-msg.correct{color:var(--success)}.feedback-msg.wrong{color:var(--error)}@media (max-width:600px){.word-display{font-size:2.2rem}.btn-lg{width:100%;justify-content:center}.tabs{overflow-x:auto;justify-content:flex-start}.header-content{padding:10px;justify-content:center}.letter-btn{width:38px;height:38px;font-size:1rem}.nav-arrow{font-size:1.8rem;padding:5px}main{padding:5px}.content-container{padding:0 5px}}
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>ğŸ“ é«˜ä¸­è‹±æ–‡æ‹¼å­—å­¸ç¿’æ©Ÿ</h1>
        <div class="header-controls">
            <select id="setSelect" class="set-select" onchange="changeSet()"><option value="0">é è¨­å–®å­— (Default) (2)</option><option value="1">é«˜äºŒæœŸæœ«è‹±æ–‡1 (32)</option><option value="2">é«˜äºŒæœŸæœ«è‹±æ–‡2 (10)</option><option value="3">é«˜äºŒæœŸæœ«è‹±æ–‡3 (12)</option></select>
            <button id="btnDeleteSet" class="icon-btn danger" onclick="deleteCurrentSet()" title="åˆªé™¤æ­¤ç¾¤çµ„">ğŸ—‘ï¸</button>
            <button class="add-btn" onclick="openModal()">â• æ–°å¢</button>
        </div>
    </div>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="setMode('study')">ğŸ“– å­¸ç¿’æ¨¡å¼</button>
    <button class="tab-btn" onclick="setMode('block')">ğŸ§© ç©æœ¨é‡çµ„</button>
    <button class="tab-btn" onclick="setMode('dictation')">âœï¸ è½å¯«æ¸¬é©—</button>
    <button class="tab-btn" onclick="setMode('cloze')">ğŸ•µï¸ å…‹æ¼å­—</button>
</div>

<main id="app">
    <button class="nav-arrow" id="btnPrev" onclick="prevWord()" title="ä¸Šä¸€ç­†" style="visibility: visible;">â®</button>

    <div class="content-container">
        <div class="progress-indicator">Word <span id="currentNum">1</span> / <span id="totalNum">2</span></div>

        <div id="mode-study" class="mode-content">
            <div class="card-display">
                <div id="wordDisplay" class="word-display"><div><span class="consonant">j</span><span class="vowel">o</span><span class="consonant">y</span><span style="color:#94a3b8;">â€§</span><span class="vowel">o</span><span class="vowel">u</span><span class="consonant">s</span></div><button class="btn-speaker" onclick="speakCurrentWord()">ğŸ”Š</button></div>
                <div id="chineseDisplay" class="meaning-display">ä»¤äººæ„‰å¿«çš„</div>
            </div>
            <div class="sentence-display">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <div id="sentenceContent" style="flex: 1;"><span class="sentence-en">The team had a joyous celebration after winning the game.</span><span class="sentence-cn">ï¼ˆçƒéšŠåœ¨è´å¾—æ¯”è³½å¾Œèˆ‰è¡Œäº†æ„‰å¿«çš„æ…¶ç¥æ´»å‹•ã€‚ï¼‰</span></div>
                    <button class="btn btn-icon" style="width: 40px; height: 40px; font-size: 1.1rem; background: var(--accent-color); flex-shrink: 0;" onclick="speakSentence()" title="æœ—è®€ä¾‹å¥">ğŸ”Š</button>
                </div>
            </div>
        </div>

        <div id="mode-block" class="mode-content" style="display:none; text-align: center;">
            <div class="meaning-display" style="margin-top:20px;"><span id="blockMeaning"></span><button class="btn-speaker" onclick="speakCurrentWord()">ğŸ”Š</button></div>
            <div class="answer-slot" id="blockAnswer"></div>
            <div class="letter-pool" id="blockPool"></div>
            <div id="blockFeedback" class="feedback-msg"></div>
        </div>

        <div id="mode-dictation" class="mode-content" style="display:none; text-align: center;">
            <div class="meaning-display" style="margin-top:30px;"><span id="dictMeaning"></span><button class="btn-speaker" onclick="speakCurrentWord()">ğŸ”Š</button></div>
            <div id="dictHint" class="hint-text"></div>
            <div class="input-group"><input type="text" id="dictInput" placeholder="è«‹è¼¸å…¥å®Œæ•´å–®å­—..." autocomplete="off"></div>
            <button class="btn btn-lg" onclick="checkDictation()">é€å‡ºæª¢æŸ¥</button>
            <div id="dictFeedback" class="feedback-msg"></div>
        </div>

        <div id="mode-cloze" class="mode-content" style="display:none; text-align: center;">
            <div class="meaning-display" style="margin-top:20px;"><span id="clozeMeaning"></span></div>
            <div class="sentence-display" style="margin: 15px 0; text-align: center; font-size: 1.2rem; background: #e0f2fe; border: 2px solid var(--primary-color);"><span id="clozeSentence"></span></div>
            <button id="btnPeek" class="btn-peek" onclick="togglePeek()">ğŸ‘€ å·çœ‹ç­”æ¡ˆ (3ç§’)</button>
            <div id="clozeHint" class="hint-text"></div>
            <div class="input-group" style="margin-top: 5px;"><input type="text" id="clozeInput" placeholder="å¡«å…¥å–®å­—..." autocomplete="off"></div>
            <button class="btn btn-lg" onclick="checkCloze()">é€å‡ºæª¢æŸ¥</button>
            <div id="clozeFeedback" class="feedback-msg"></div>
        </div>
    </div>

    <button class="nav-arrow" id="btnNext" onclick="nextWord()" title="ä¸‹ä¸€ç­†" style="visibility: visible;">â¯</button>
</main>

<footer>
    <div class="footer-btn-group">
        <button class="footer-btn primary" onclick="exportDataToClipboard()">ğŸ“¤ åŒ¯å‡ºè³‡æ–™ (è¤‡è£½)</button>
        <button class="footer-btn primary" onclick="importDataFromClipboard()">ğŸ“¥ åŒ¯å…¥è³‡æ–™ (è²¼ä¸Š)</button>
    </div>
    <div style="font-size: 0.9rem; color: #94a3b8; cursor: pointer; margin-top: 15px;" onclick="downloadApp()">ğŸ’¾ å‚™ä»½å®Œæ•´ç¨‹å¼ (ä¸‹è¼‰ index.html)</div>
    <div style="font-size: 0.9rem; color: #94a3b8; cursor: pointer; margin-top: 5px;" onclick="resetData()">â†º é‡ç½®æ‰€æœ‰è³‡æ–™</div>
</footer>

<div id="addModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header"><h2>âœ¨ æ–°å¢å–®å­—</h2></div>
        <div class="modal-tabs"><button class="modal-tab-btn" onclick="switchModalTab('single')">å–®ç­†</button><button class="modal-tab-btn active" onclick="switchModalTab('bulk')">æ‰¹é‡ (Smart Paste)</button></div>
        <div class="modal-body">
            <div id="tab-single" class="modal-tab-content" style="display: none;">
                <div class="form-group"><label>å–®å­—</label><input type="text" id="newWord"></div><div class="form-group"><label>ä¸­æ–‡</label><input type="text" id="newMeaning"></div>
                <div class="modal-actions"><button class="btn" onclick="saveNewWord()">åŠ å…¥</button><button class="btn btn-outline" onclick="closeModal()">é—œé–‰</button></div>
            </div>
            <div id="tab-bulk" class="modal-tab-content" style="display: block;">
                <div class="form-group"><label>ç¾¤çµ„åç¨±</label><input type="text" id="newSetName" placeholder="ä¾‹ï¼šæœŸæœ«è€ƒç¯„åœ"></div>
                <textarea id="bulkText" class="bulk-input" placeholder="è²¼ä¸Šæ–‡å­—..."></textarea>
                <div class="modal-actions"><button class="btn" onclick="parseAndImport()">åŠ å…¥</button><button class="btn btn-outline" onclick="closeModal()">é—œé–‰</button></div>
            </div>
        </div>
    </div>
</div>
<div id="dataModal" class="modal-overlay" style="display: none;"><div class="modal"><div class="modal-header"><h2>ğŸ’¾ è³‡æ–™å‚³è¼¸</h2></div><div class="modal-body"><p id="dataModalDesc" style="color:var(--text-light);margin-bottom:10px;">è«‹è²¼ä¸Šä»£ç¢¼ï¼š</p><textarea id="dataTextarea" class="bulk-input" style="height:150px;"></textarea><div class="modal-actions"><button class="btn btn-outline" onclick="closeDataModal()">é—œé–‰</button><button id="dataActionBtn" class="btn">ç¢ºèªåŒ¯å…¥</button></div></div></div></div>
<div id="resultModal" class="modal-overlay"><div class="modal" style="max-width: 400px;"><div class="modal-header"><h2>ğŸ† æ¸¬é©—å®Œæˆï¼</h2></div><div class="modal-body"><p>å·çœ‹æ¬¡æ•¸</p><h1 id="resultPeeks" style="font-size: 4rem; color: var(--primary-color);">0</h1><p id="resultComment"></p></div><div class="modal-actions" style="justify-content: center; padding: 20px;"><button class="btn btn-lg" onclick="closeResultModal()">å†ä¾†ä¸€æ¬¡</button></div></div></div>

<script>
    // é è¨­è³‡æ–™ï¼šé€™è£¡åªæ”¾æœ€åŸºæœ¬çš„ï¼Œä¸æœƒè¦†è“‹æ‚¨æ‰‹æ©Ÿè£¡çš„è³‡æ–™
    const defaultSets = [{"name": "é è¨­ç¯„ä¾‹", "words": [{"id": 1, "word": "welcome", "syllable": "welâ€§come", "meaning": "æ­¡è¿", "sentence": "Welcome to the class!"}]}];

    const FORCE_UPDATE_FROM_CODE = false; // è¨­å®šç‚º falseï¼šå„ªå…ˆä½¿ç”¨ç€è¦½å™¨å…§çš„èˆŠè³‡æ–™

    let state = { wordSets: [], currentSetIndex: 0, currentIndex: 0, mode: 'study', voices: [], bestVoice: null, chineseVoice: null, blockGuess: [], clozeOrder: [], clozeCurrentIndex: 0, clozePeeksTotal: 0, isPeeking: false };

    function init() { loadData(); initVoices(); renderSetSelect(); updateUI(); document.getElementById('dictInput').addEventListener('keypress', (e) => { if(e.key==='Enter') checkDictation(); }); document.getElementById('clozeInput').addEventListener('keypress', (e) => { if(e.key==='Enter') checkCloze(); }); }

    function loadData() {
        const storedSets = localStorage.getItem('spellingBeeSets');
        if (storedSets) {
            try { state.wordSets = JSON.parse(storedSets); } catch(e) { state.wordSets = JSON.parse(JSON.stringify(defaultSets)); }
        } else {
            state.wordSets = JSON.parse(JSON.stringify(defaultSets));
        }
        saveSetsToStorage();
    }
    function saveSetsToStorage() { localStorage.setItem('spellingBeeSets', JSON.stringify(state.wordSets)); }
    function resetData() { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿè³‡æ–™æœƒæ¸…ç©ºå–”ï¼")) { localStorage.removeItem('spellingBeeSets'); location.reload(); } }
    function downloadApp() {
        let html = document.documentElement.outerHTML;
        const blob = new Blob([html], {type: 'text/html'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'spelling_bee_backup.html'; a.click();
    }
    function exportDataToClipboard() {
        const json = JSON.stringify(state.wordSets);
        document.getElementById('dataModal').style.display = 'flex'; document.getElementById('dataModalDesc').innerText = 'è«‹è¤‡è£½ä¸‹æ–¹ä»£ç¢¼ï¼Œå­˜åˆ°è¨˜äº‹æœ¬æˆ–å‚³çµ¦åˆ¥äººï¼š';
        const area = document.getElementById('dataTextarea'); area.value = json; area.select();
        const btn = document.getElementById('dataActionBtn'); btn.innerText = "è¤‡è£½ä»£ç¢¼";
        btn.onclick = () => { navigator.clipboard.writeText(json).then(() => { alert("å·²è¤‡è£½ï¼"); closeDataModal(); }).catch(()=>alert("è«‹æ‰‹å‹•è¤‡è£½")); };
    }
    function importDataFromClipboard() {
        document.getElementById('dataModal').style.display = 'flex'; document.getElementById('dataModalDesc').innerText = 'è«‹è²¼ä¸Šä»£ç¢¼ï¼š'; document.getElementById('dataTextarea').value = '';
        const btn = document.getElementById('dataActionBtn'); btn.innerText = "ç¢ºèªåŒ¯å…¥";
        btn.onclick = () => {
            try {
                const data = JSON.parse(document.getElementById('dataTextarea').value);
                if (Array.isArray(data) && confirm("é€™æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ")) { state.wordSets = data; saveSetsToStorage(); renderSetSelect(); updateUI(); closeDataModal(); alert("åŒ¯å…¥æˆåŠŸï¼"); }
            } catch(e) { alert("ä»£ç¢¼æ ¼å¼éŒ¯èª¤"); }
        };
    }
    function closeDataModal() { document.getElementById('dataModal').style.display = 'none'; }
    function renderSetSelect() {
        const select = document.getElementById('setSelect'); select.innerHTML = '';
        state.wordSets.forEach((set, index) => { const option = document.createElement('option'); option.value = index; option.text = `${set.name} (${set.words.length})`; select.appendChild(option); });
        if (state.currentSetIndex >= state.wordSets.length) state.currentSetIndex = 0; select.value = state.currentSetIndex;
    }
    function changeSet() { state.currentSetIndex = parseInt(document.getElementById('setSelect').value); state.currentIndex = 0; if (state.mode === 'cloze') initClozeMode(); updateUI(); }
    function deleteCurrentSet() { if (state.wordSets.length <= 1) return alert("ä¸èƒ½åˆªé™¤æœ€å¾Œä¸€å€‹ç¾¤çµ„"); if (confirm(`åˆªé™¤ã€Œ${state.wordSets[state.currentSetIndex].name}ã€ï¼Ÿ`)) { state.wordSets.splice(state.currentSetIndex, 1); state.currentSetIndex = 0; saveSetsToStorage(); renderSetSelect(); state.currentIndex = 0; updateUI(); } }
    function initVoices() { function setV() { state.voices = window.speechSynthesis.getVoices(); state.bestVoice = state.voices.find(v => v.name.includes("Google US")) || state.voices.find(v => v.lang === "en-US") || state.voices[0]; state.chineseVoice = state.voices.find(v => v.lang.includes("zh-TW")) || state.voices.find(v => v.lang.includes("zh")); } setV(); speechSynthesis.onvoiceschanged = setV; }
    function speakText(t, zh=false) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.voice = zh ? state.chineseVoice : state.bestVoice; u.lang = zh ? "zh-TW" : "en-US"; u.rate = zh ? 1.1 : 0.8; window.speechSynthesis.speak(u); }
    function speakCurrentWord() { const w=getCurrentWord(); if(w) speakText(w.word); }
    function speakSentence() { const w=getCurrentWord(); if(!w||!w.sentence)return; let t=w.sentence; const m=t.match(/[\u4e00-\u9fa5ï¼ˆ]/); if(m) t=t.substring(0, m.index); speakText(t); }
    function getCurrentWord() { const w=state.wordSets[state.currentSetIndex].words; if(w.length===0)return null; return state.mode==='cloze'?w[state.clozeOrder[state.clozeCurrentIndex]]:w[state.currentIndex]; }
    function updateUI() {
        const w = getCurrentWord(); if(!w) { document.getElementById('wordDisplay').innerText="ç„¡è³‡æ–™"; return; }
        const isCloze = state.mode==='cloze'; document.getElementById('btnPrev').style.visibility = isCloze?'hidden':'visible'; document.getElementById('btnNext').style.visibility = isCloze?'hidden':'visible'; document.getElementById('currentNum').innerText = isCloze?(state.clozeCurrentIndex+1):(state.currentIndex+1); document.getElementById('totalNum').innerText = state.wordSets[state.currentSetIndex].words.length;
        if(state.mode==='study') renderStudy(w); else if(state.mode==='block') renderBlock(w); else if(state.mode==='dictation') renderDictation(w); else if(state.mode==='cloze') renderCloze(w);
    }
    function prevWord() { if(state.currentIndex>0) {state.currentIndex--; updateUI();} }
    function nextWord() { if(state.currentIndex < state.wordSets[state.currentSetIndex].words.length-1) {state.currentIndex++; updateUI();} }
    function setMode(m) { state.mode=m; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-btn')[['study','block','dictation','cloze'].indexOf(m)].classList.add('active'); document.querySelectorAll('.mode-content').forEach(d=>d.style.display='none'); document.getElementById('mode-'+m).style.display='block'; if(m==='cloze') initClozeMode(); else updateUI(); }
    function renderStudy(w) { let h=''; const t=w.syllable||w.word; for(let c of t) { if(/[aeiou]/i.test(c)) h+=`<span class="vowel">${c}</span>`; else if(/[a-z]/i.test(c)) h+=`<span class="consonant">${c}</span>`; else h+=`<span style="color:#94a3b8;">${c}</span>`; } document.getElementById('wordDisplay').innerHTML = `<div>${h}</div><button class="btn-speaker" onclick="speakCurrentWord()">ğŸ”Š</button>`; document.getElementById('chineseDisplay').innerText = w.meaning; const d = document.getElementById('sentenceContent'); const s = (w.sentence||"").search(/[\u4e00-\u9fa5ï¼ˆ]/); if(s!==-1) d.innerHTML = `<span class="sentence-en">${w.sentence.substring(0,s)}</span><span class="sentence-cn">${w.sentence.substring(s)}</span>`; else d.innerHTML = `<span class="sentence-en">${w.sentence||""}</span>`; }
    function renderBlock(w) { document.getElementById('blockMeaning').innerText = w.meaning; state.blockGuess=[]; const p=document.getElementById('blockPool'); const a=document.getElementById('blockAnswer'); p.innerHTML=''; a.innerHTML=''; w.word.replace(/[^a-zA-Z]/g,'').split('').sort(()=>Math.random()-0.5).forEach(c=>{ const b=document.createElement('div'); b.className='letter-btn'; b.innerText=c; b.onclick=(e)=>addBlock(c,e.currentTarget); p.appendChild(b); }); document.getElementById('blockFeedback').className='feedback-msg'; }
    function addBlock(c, btn) { const w = getCurrentWord().word.replace(/[^a-zA-Z]/g,''); if(state.blockGuess.length>=w.length) return; if(c.toLowerCase()!==w[state.blockGuess.length].toLowerCase()) { btn.classList.add('shake'); setTimeout(()=>btn.classList.remove('shake'),400); return; } btn.classList.add('used'); state.blockGuess.push({c, btn}); renderBlockAnswer(); if(state.blockGuess.map(x=>x.c).join('')===w) feedback('blockFeedback',true); }
    function renderBlockAnswer(){ const a=document.getElementById('blockAnswer'); a.innerHTML=''; state.blockGuess.forEach((o,i)=>{ const b=document.createElement('div'); b.className='letter-btn'; b.innerText=o.c; b.onclick=()=>{ state.blockGuess.splice(i).forEach(x=>x.btn.classList.remove('used')); renderBlockAnswer(); }; a.appendChild(b); }); }
    function renderDictation(w) { document.getElementById('dictMeaning').innerText=w.meaning; document.getElementById('dictHint').innerText=`${w.word[0]} ... ${w.word[w.word.length-1]}`; document.getElementById('dictInput').value=''; document.getElementById('dictFeedback').className='feedback-msg'; }
    function checkDictation() { const v = document.getElementById('dictInput').value.trim().toLowerCase(); feedback('dictFeedback', v===getCurrentWord().word.toLowerCase()); }
    function initClozeMode() { state.clozeOrder = Array.from(state.wordSets[state.currentSetIndex].words.keys()).sort(()=>Math.random()-0.5); state.clozeCurrentIndex=0; state.clozePeeksTotal=0; updateUI(); }
    function renderCloze(w) { document.getElementById('clozeMeaning').innerText=""; let s = w.sentence||""; const idx=s.search(/[\u4e00-\u9fa5ï¼ˆ]/); if(idx!==-1) s=s.substring(0,idx); const esc = w.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const masked = s.replace(new RegExp(`\\b${esc}\\b`,'gi'), m=>`<span class="cloze-word">${m[0]}<span class="cloze-line"></span>${m[m.length-1]}</span>`); document.getElementById('clozeSentence').innerHTML = masked; document.getElementById('clozeHint').innerText = `${w.word[0]} ... ${w.word[w.word.length-1]}`; document.getElementById('clozeInput').value=''; document.getElementById('clozeInput').disabled=false; document.getElementById('clozeInput').focus(); document.getElementById('clozeFeedback').className='feedback-msg'; document.getElementById('btnPeek').disabled=false; document.getElementById('btnPeek').innerText="ğŸ‘€ å·çœ‹ç­”æ¡ˆ (3ç§’)"; }
    function togglePeek() { if(state.isPeeking) return; state.isPeeking=true; state.clozePeeksTotal++; const h=document.getElementById('clozeHint'); const w=getCurrentWord().word; h.innerText=w; h.style.color="#ef4444"; const b=document.getElementById('btnPeek'); b.disabled=true; b.innerText="è¨˜ä½ç­”æ¡ˆ..."; setTimeout(()=>{ h.innerText=`${w[0]} ... ${w[w.length-1]}`; h.style.color="var(--primary-color)"; state.isPeeking=false; b.disabled=false; b.innerText="ğŸ‘€ å·çœ‹ç­”æ¡ˆ (3ç§’)"; },3000); }
    function checkCloze() { const v=document.getElementById('clozeInput'); const w=getCurrentWord().word; if(v.value.trim().toLowerCase()===w.toLowerCase()) { feedback('clozeFeedback',true); v.disabled=true; setTimeout(()=>{ if(state.clozeCurrentIndex<state.clozeOrder.length-1){state.clozeCurrentIndex++; updateUI();} else {document.getElementById('resultModal').style.display='flex'; document.getElementById('resultPeeks').innerText=state.clozePeeksTotal; document.getElementById('resultComment').innerText=state.clozePeeksTotal<3?"å¤ªç¥äº†ï¼":"å†æ¥å†å²ï¼";} },1500); } else { feedback('clozeFeedback',false); v.classList.add('shake'); setTimeout(()=>v.classList.remove('shake'),400); } }
    function closeResultModal() { document.getElementById('resultModal').style.display='none'; initClozeMode(); }
    function feedback(id, ok) { const el=document.getElementById(id); el.innerText=ok?"Correct! ğŸ‰":"Try Again! ğŸ’ª"; el.className=`feedback-msg show ${ok?'correct':'wrong'}`; if(ok) speakText(ok?"Nice!":"åŠ æ²¹", true); }
    function openModal() { document.getElementById('addModal').style.display='flex'; switchModalTab('single'); }
    function closeModal() { document.getElementById('addModal').style.display='none'; }
    function switchModalTab(t) { document.querySelectorAll('.modal-tab-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.modal-tab-content').forEach(c=>c.style.display='none'); document.querySelectorAll('.modal-tab-btn')[t==='single'?0:1].classList.add('active'); document.getElementById('tab-'+t).style.display='block'; }
    function saveNewWord() { const w=document.getElementById('newWord').value.trim().toLowerCase(); const m=document.getElementById('newMeaning').value.trim(); if(!w||!m) return alert("è«‹è¼¸å…¥"); state.wordSets[state.currentSetIndex].words.push({id:Date.now(), word:w, meaning:m, syllable:w, sentence:""}); localStorage.setItem('spellingBeeSets', JSON.stringify(state.wordSets)); closeModal(); updateUI(); }
    function parseAndImport() { const txt=document.getElementById('bulkText').value; const name=document.getElementById('newSetName').value||"æœªå‘½å"; let wArr=[]; let curr={}; const push=()=>{if(curr.w&&curr.m) wArr.push({id:Date.now()+Math.random(), word:curr.w, meaning:curr.m, syllable:curr.s||curr.w, sentence:curr.st});}; txt.split('\n').forEach(l=>{ l=l.trim(); if(!l)return; const m=l.match(/^\d+\.\s*([a-zA-Z\s\-]+)/); if(m){push(); curr={w:m[1].trim().toLowerCase(),s:"",m:"",st:""}; return;} if(l.match(/éŸ³ç¯€|Syllable/i)) curr.s=l.replace(/^(éŸ³ç¯€|Syllable)[:ï¼š]/i,'').trim(); else if(l.match(/ä¸­æ–‡|Meaning/i)) curr.m=l.replace(/^(ä¸­æ–‡|Meaning)[:ï¼š]/i,'').trim(); else if(l.match(/ä¾‹å¥|Sentence/i)) curr.st=l.replace(/^(ä¾‹å¥|Sentence)[:ï¼š]/i,'').trim(); }); push(); if(wArr.length>0) { state.wordSets.push({name, words:wArr}); localStorage.setItem('spellingBeeSets', JSON.stringify(state.wordSets)); closeModal(); renderSetSelect(); state.currentSetIndex=state.wordSets.length-1; state.currentIndex=0; updateUI(); } else alert("æ ¼å¼ä¸ç¬¦"); }

    window.onload = init;
</script>

</body></html>